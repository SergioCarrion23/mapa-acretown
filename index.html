<script>
  async function initMap() {
    const map = new google.maps.Map(document.getElementById("map"), {
      zoom: 5,
      center: { lat: 39.5, lng: -98.35 } // centro de USA
    });

    const sheetId = "1UU6QeID1wbqugVXkJJM6DWZpHhzqKUuCYarKB-SWK0I";
    const sheetGid = "283380080";
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=${sheetGid}`;

    const response = await fetch(url);
    const text = await response.text();

    // El JSON viene envuelto en un callback, asÃ­ que lo limpiamos
    const json = JSON.parse(text.substring(47, text.length - 2));
    const rows = json.table.rows;

    const infoWindow = new google.maps.InfoWindow();
    const bounds = new google.maps.LatLngBounds();

    rows.forEach(r => {
      const status = r.c[0]?.v || "";  // Columna A
      const title = r.c[1]?.v || "";   // Columna B
      const price = r.c[2]?.v || "";   // Columna C
      const address = r.c[3]?.v || ""; // Columna D
      const acres = r.c[4]?.v || "";   // Columna E
      const lat = parseFloat(r.c[5]?.v) || 0;  // Columna F
      const lng = parseFloat(r.c[6]?.v) || 0;  // Columna G
      const link = r.c[7]?.v || "#";   // Columna H
      const photo = r.c[8]?.v || "https://placehold.co/800x500?text=No+Image"; // Columna I

      if (!lat || !lng) return; // omitir filas sin coordenadas

      const marker = new google.maps.Marker({
        position: { lat, lng },
        map,
        title,
        icon: status.toLowerCase().includes("sold")
          ? "https://maps.google.com/mapfiles/ms/icons/gray-dot.png"
          : "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
      });

      marker.addListener("click", () => {
        const container = document.createElement("div");
        container.className = "infowin";
        container.innerHTML = `
          <h3>${title}</h3>
          <img id="iw-img" src="${photo}" alt="Featured photo for ${title}">
          <p>${address}</p>
          <p>${acres} acres</p>
          <p class="price">${price}</p>
          <p><a href="${link}" target="_blank">View Property</a></p>
        `;

        const img = container.querySelector('#iw-img');
        img.addEventListener('load', () => infoWindow.setContent(container));
        img.addEventListener('error', () => {
          img.src = 'https://placehold.co/800x500?text=No+Image';
          infoWindow.setContent(container);
        });

        infoWindow.setContent(container);
        infoWindow.open({ map, anchor: marker });
      });

      bounds.extend({ lat, lng });
    });

    map.fitBounds(bounds);
  }
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAICOnPq_rKDMXcA5WF5huQWRskOag-ENQ&callback=initMap">
</script>

    <code>https://www.google.com/maps?q=100+Olivas+Rd,+Los+Lunas,+NM+87031&z=12&output=embed</code>
  </p>
</body>
</html>
